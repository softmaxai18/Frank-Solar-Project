<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Water Heater System Rankings (0â€“5)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            padding: 20px;
            background: #f5f7fa;
            max-width: 1200px;
            margin: 0 auto;
        }

        .chart-container {
            position: relative;
            height: 700px;
            width: 100%;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 15px;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 1.5rem;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .legend-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 6px;
        }
    </style>
</head>

<body>

    <h2>ðŸ”¥ Ranked Comparison of Water Heater Types</h2>
    <p class="subtitle">All metrics normalized to 0â€“5 (higher is better)</p>

    <div class="chart-container">
        <canvas id="heaterChart"></canvas>
    </div>

    <div class="legend-container" id="legendContainer"></div>

    <script>
        // Scores normalized to 0â€“5 (higher is better)
        const data = {
                    "categories": [
                        "Affordability Rank",
                        "Annual Cost",
                        "Abundance Rank",
                        "Environmental Rank",
                        "COâ‚‚ Emissions",
                        "Reliability Rank",
                        "Complexity"
                    ],
                    "heaters": {
                        "Electric Tank":        [0, 5, 0, 5, 0, 5, 0],
                        "Electric Tankless":    [1, 3, 1, 3, 1, 3, 1],
                        "Heat Pump":            [4, 1, 4, 1, 4, 1, 4],
                        "Natural Gas Tank":     [3, 2, 3, 2, 3, 2, 3],
                        "Natural Gas Tankless": [1, 2, 1, 2, 1, 2, 1],
                        "Active Solar":         [5, 4, 5, 4, 5, 4, 5]
                    }
                }

        const ctx = document.getElementById('heaterChart').getContext('2d');
        const categories = data.categories;
        const heaterNames = Object.keys(data.heaters);

        const colorPalette = [
            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'
        ];

        const datasets = heaterNames.map((name, i) => ({
            label: name,
            data: data.heaters[name],
            backgroundColor: colorPalette[i],
            borderColor: colorPalette[i],
            borderWidth: 1,
            borderRadius: 3,
            barThickness: 10,
            categoryPercentage: 0.7,
            barPercentage: 0.8
        }));

        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.parsed.x.toFixed(2)} / 5`;
                            }
                        },
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 12 },
                        bodyFont: { size: 11 },
                        padding: 8
                    },
                    title: {
                        display: true,
                        text: 'System Performance Rankings (Normalized 0â€“5 Scale)'
                    }
                },
                onClick: function (evt, activeEls) {
                    if (activeEls.length > 0) {
                        const chartEl = activeEls[0];
                        const datasetIndex = chartEl.datasetIndex;
                        const dataIndex = chartEl.index;

                        const systemName = chart.data.datasets[datasetIndex].label;
                        const metric = chart.data.labels[dataIndex];
                        const score = chart.data.datasets[datasetIndex].data[dataIndex];

                        const payload = {
                            system: systemName,
                            metric: metric,
                            score: score
                        };

                        console.log("Clicked:", payload);
                        fetch("/chat/click-log", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload)
                        })
                            .then(res => res.json())
                            .then(data => console.log("Server response:", data))
                            .catch(err => console.error("Error sending to API:", err));
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: 5,
                        title: {
                            display: true,
                            text: 'Score (0 to 5)',
                            font: { weight: 'bold', size: 12 }
                        },
                        ticks: {
                            stepSize: 1
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Performance Metric',
                            font: { weight: 'bold', size: 12 }
                        },
                        ticks: {
                            font: { size: 11 }
                        },
                        grid: { display: false }
                    }
                },
                layout: {
                    padding: { top: 15, right: 15 }
                }
            }
        });
        // Create custom legend
        const legendContainer = document.getElementById('legendContainer');
        chart.data.datasets.forEach((dataset, i) => {
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';

            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color';
            colorBox.style.backgroundColor = dataset.backgroundColor;

            const label = document.createElement('span');
            label.textContent = dataset.label;

            legendItem.appendChild(colorBox);
            legendItem.appendChild(label);
            legendContainer.appendChild(legendItem);
        });
    </script>

</body>

</html>